<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>🧮 Equations-Parser WebAssembly Test - Phase 2</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
        
        .container {
            background: white;
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }
        
        h1 {
            color: #333;
            text-align: center;
            margin-bottom: 10px;
            font-size: 2.5em;
        }
        
        .subtitle {
            text-align: center;
            color: #666;
            margin-bottom: 30px;
            font-size: 1.1em;
        }
        
        .status {
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
            font-weight: bold;
            text-align: center;
        }
        
        .status.loading {
            background: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }
        
        .status.ready {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .status.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        
        .section {
            margin: 30px 0;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 10px;
            border-left: 5px solid #007bff;
        }
        
        .section h2 {
            color: #333;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .equation-input {
            display: flex;
            gap: 15px;
            align-items: center;
            margin: 15px 0;
            flex-wrap: wrap;
        }
        
        .equation-input input[type="text"] {
            flex: 1;
            padding: 12px 15px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 16px;
            min-width: 300px;
            font-family: 'Courier New', monospace;
        }
        
        .equation-input input[type="text"]:focus {
            border-color: #007bff;
            outline: none;
            box-shadow: 0 0 0 3px rgba(0,123,255,0.25);
        }
        
        button {
            background: linear-gradient(135deg, #007bff, #0056b3);
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s ease;
            font-size: 14px;
        }
        
        button:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,123,255,0.4);
        }
        
        button:disabled {
            background: #6c757d;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
        
        .result {
            margin-top: 15px;
            padding: 15px;
            border-radius: 8px;
            font-family: 'Courier New', monospace;
        }
        
        .result.success {
            background: #d4edda;
            color: #155724;
            border: 2px solid #c3e6cb;
        }
        
        .result.error {
            background: #f8d7da;
            color: #721c24;
            border: 2px solid #f5c6cb;
        }
        
        .result-value {
            font-size: 18px;
            font-weight: bold;
            margin: 5px 0;
        }
        
        .result-meta {
            font-size: 12px;
            opacity: 0.8;
            margin-top: 8px;
        }
        
        .quick-tests {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }
        
        .quick-test {
            background: white;
            padding: 15px;
            border-radius: 8px;
            border: 1px solid #dee2e6;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .quick-test:hover {
            border-color: #007bff;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
        
        .quick-test-category {
            font-weight: bold;
            color: #007bff;
            font-size: 14px;
            margin-bottom: 8px;
        }
        
        .quick-test-equation {
            font-family: 'Courier New', monospace;
            background: #f8f9fa;
            padding: 8px;
            border-radius: 4px;
            margin: 5px 0;
            font-size: 14px;
        }
        
        .quick-test-description {
            font-size: 12px;
            color: #666;
        }
        
        .console {
            background: #1a1a1a;
            color: #00ff00;
            padding: 20px;
            border-radius: 8px;
            font-family: 'Courier New', monospace;
            font-size: 13px;
            max-height: 400px;
            overflow-y: auto;
            white-space: pre-wrap;
            margin-top: 15px;
        }
        
        .function-list {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }
        
        .function-category {
            background: white;
            padding: 20px;
            border-radius: 12px;
            border: 1px solid #e9ecef;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
            transition: transform 0.2s, box-shadow 0.2s;
        }
        
        .function-category:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 16px rgba(0,0,0,0.1);
        }
        
        .function-category h3 {
            margin: 0 0 15px 0;
            color: #007bff;
            font-size: 18px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
            border-bottom: 2px solid #f1f3f4;
            padding-bottom: 8px;
        }
        
        .function-category ul {
            margin: 0;
            padding: 0;
            list-style: none;
            font-size: 14px;
            line-height: 1.6;
        }
        
        .function-category li {
            padding: 6px 0;
            border-bottom: 1px solid #f8f9fa;
            font-family: 'Courier New', monospace;
            color: #495057;
        }
        
        .function-category li:last-child {
            border-bottom: none;
        }
        
        .function-category li:hover {
            background-color: #f8f9fa;
            border-radius: 4px;
            padding-left: 8px;
            transition: all 0.2s;
            cursor: pointer;
        }
        
        .function-search {
            margin-bottom: 20px;
            position: relative;
        }
        
        .function-search input {
            width: 100%;
            padding: 12px 40px 12px 15px;
            border: 2px solid #dee2e6;
            border-radius: 8px;
            font-size: 16px;
            box-sizing: border-box;
        }
        
        .function-search input:focus {
            border-color: #007bff;
            outline: none;
            box-shadow: 0 0 0 3px rgba(0,123,255,0.1);
        }
        
        .search-icon {
            position: absolute;
            right: 12px;
            top: 50%;
            transform: translateY(-50%);
            color: #6c757d;
        }
        
        .test-results {
            margin-top: 20px;
        }
        
        .test-summary {
            display: flex;
            gap: 20px;
            margin-bottom: 15px;
            justify-content: center;
        }
        
        .test-stat {
            padding: 10px 20px;
            border-radius: 8px;
            font-weight: bold;
            text-align: center;
        }
        
        .test-stat.passed {
            background: #d4edda;
            color: #155724;
        }
        
        .test-stat.failed {
            background: #f8d7da;
            color: #721c24;
        }
        
        .test-details {
            max-height: 300px;
            overflow-y: auto;
        }
        
        .test-item {
            padding: 10px;
            margin: 5px 0;
            border-radius: 4px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
        }
        
        .test-item.passed {
            background: #d4edda;
            border-left: 4px solid #28a745;
        }
        
        .test-item.failed {
            background: #f8d7da;
            border-left: 4px solid #dc3545;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>🧮 Parsec WebAssembly Playground</h1>
        <p class="subtitle">
            Comprehensive mathematical expression evaluation powered by C++ equations-parser library compiled to WebAssembly
        </p>
        
        <div id="status" class="status loading">
            🔄 Initializing Equations-Parser WebAssembly module...
        </div>

        <div class="section">
            <h2>🎯 Interactive Equation Evaluation</h2>
            <p>Enter any mathematical expression and see the result with type information:</p>
            
            <div class="equation-input">
                <input type="text" id="equationInput" placeholder='Try: sin(pi/2), sqrt(16), concat("Hello", " World"), 5 > 3 ? "yes" : "no"' />
                <button onclick="evaluateEquation()" id="evalBtn" disabled>Evaluate</button>
                <button onclick="clearResult()" id="clearBtn" disabled>Clear</button>
            </div>
            
            <div id="evaluationResult"></div>
        </div>

        <div class="section">
            <h2>⚡ Quick Test Examples</h2>
            <p>Click on any example below to test it instantly:</p>
            <div class="quick-tests" id="quickTests">
                <!-- Quick tests will be populated by JavaScript -->
            </div>
        </div>

        <div class="section">
            <h2>🧪 Comprehensive Test Suite</h2>
            <p>Run automated tests to verify all equations-parser functionality:</p>
            <button onclick="runComprehensiveTests()" id="testBtn" disabled>Run All Tests</button>
            <div id="testResults"></div>
        </div>

        <div class="section">
            <h2>📋 Supported Functions</h2>
            <p>Complete list of available mathematical functions and operations (click on any function to try it):</p>
            <div class="function-search">
                <input type="text" id="functionSearch" placeholder="Search functions... (e.g., sin, log, concat)" onkeyup="filterFunctions()">
                <span class="search-icon">🔍</span>
            </div>
            <div class="function-list" id="functionList">
                <!-- Function list will be populated by JavaScript -->
            </div>
        </div>

        <div class="section">
            <h2>📊 Console Output</h2>
            <p>Real-time C++ and JavaScript debug information:</p>
            <div id="console" class="console"></div>
            <button onclick="clearConsole()" style="margin-top: 10px;">Clear Console</button>
        </div>
    </div>

    <script type="module">
        // Import our wrapper
        let EquationsParserWrapper;
        let equationsParser;

        // Console capture for display
        const originalLog = console.log;
        const originalError = console.error;
        const consoleOutput = document.getElementById('console');

        function appendToConsole(message, type = 'log') {
            const timestamp = new Date().toLocaleTimeString();
            const color = type === 'error' ? '#ff6b6b' : '#00ff00';
            consoleOutput.innerHTML += `<span style="color: ${color}">[${timestamp}] ${message}</span>\n`;
            consoleOutput.scrollTop = consoleOutput.scrollHeight;
        }

        console.log = function(...args) {
            originalLog.apply(console, args);
            appendToConsole(args.join(' '), 'log');
        };

        console.error = function(...args) {
            originalError.apply(console, args);
            appendToConsole(args.join(' '), 'error');
        };

        window.clearConsole = function() {
            consoleOutput.innerHTML = '';
        };

        // Status update helper
        function updateStatus(message, type = 'loading') {
            const status = document.getElementById('status');
            status.textContent = message;
            status.className = `status ${type}`;
        }

        // Initialize WebAssembly
        async function initializeEquationsParser() {
            try {
                updateStatus('🔄 Loading Equations-Parser wrapper...', 'loading');
                
                // Import the wrapper
                const module = await import('../js/equations_parser_wrapper.js');
                EquationsParserWrapper = module.default;

                updateStatus('🔄 Initializing Equations-Parser WebAssembly module...', 'loading');
                equationsParser = new EquationsParserWrapper();
                await equationsParser.initialize();
                
                updateStatus('✅ Equations-Parser WebAssembly module ready!', 'ready');
                
                // Enable buttons
                document.getElementById('evalBtn').disabled = false;
                document.getElementById('clearBtn').disabled = false;
                document.getElementById('testBtn').disabled = false;
                
                // Populate quick tests and function list
                populateQuickTests();
                populateFunctionList();
                
                console.log('🎉 All systems ready! Try evaluating some equations.');
                
            } catch (error) {
                console.error('Initialization failed:', error);
                updateStatus(`❌ Failed to load: ${error.message}`, 'error');
            }
        }

        // Evaluate equation function
        window.evaluateEquation = function() {
            const input = document.getElementById('equationInput');
            const resultDiv = document.getElementById('evaluationResult');
            
            if (!input.value.trim()) {
                resultDiv.innerHTML = '<div class="result error">Please enter an equation</div>';
                return;
            }
            
            try {
                const result = equationsParser.evaluateEquation(input.value.trim());
                
                if (result.success) {
                    resultDiv.innerHTML = `
                        <div class="result success">
                            <div class="result-value">Result: ${result.value}</div>
                            <div class="result-meta">
                                Type: ${result.type} | Equation: ${result.equation}
                            </div>
                        </div>
                    `;
                } else {
                    resultDiv.innerHTML = `
                        <div class="result error">
                            <div class="result-value">Error: ${result.error}</div>
                            <div class="result-meta">Equation: ${result.equation}</div>
                        </div>
                    `;
                }
            } catch (error) {
                resultDiv.innerHTML = `
                    <div class="result error">
                        <div class="result-value">JavaScript Error: ${error.message}</div>
                    </div>
                `;
            }
        };

        // Clear result function
        window.clearResult = function() {
            document.getElementById('evaluationResult').innerHTML = '';
            document.getElementById('equationInput').value = '';
        };

        // Quick test examples
        function populateQuickTests() {
            const quickTests = [
                { category: '🧮 Basic Arithmetic', equation: '2 + 3 * 4', description: 'Order of operations' },
                { category: '🧮 Basic Arithmetic', equation: '(5 + 3) / 2', description: 'Parentheses and division' },
                { category: '📐 Trigonometry', equation: 'sin(pi/2)', description: 'Sine of π/2' },
                { category: '📐 Trigonometry', equation: 'cos(0)', description: 'Cosine of 0' },
                { category: '📊 Functions', equation: 'sqrt(16)', description: 'Square root' },
                { category: '📊 Functions', equation: 'abs(-5)', description: 'Absolute value' },
                { category: '📊 Functions', equation: 'round(3.7)', description: 'Rounding function' },
                { category: '🔤 Strings', equation: 'length("test")', description: 'String length' },
                { category: '❓ Conditionals', equation: '5 > 3', description: 'Comparison operator' },
                { category: '❓ Conditionals', equation: '5 > 3 ? "yes" : "no"', description: 'Ternary operator' },
                { category: '🔢 Constants', equation: 'pi * 2', description: 'Using π constant' },
                { category: '🔢 Constants', equation: 'e ^ 1', description: 'Using e constant' },
            ];

            const quickTestsDiv = document.getElementById('quickTests');
            quickTestsDiv.innerHTML = quickTests.map(test => `
                <div class="quick-test" onclick="runQuickTest('${test.equation}')">
                    <div class="quick-test-category">${test.category}</div>
                    <div class="quick-test-equation">${test.equation}</div>
                    <div class="quick-test-description">${test.description}</div>
                </div>
            `).join('');
        }

        // Run quick test
        window.runQuickTest = function(equation) {
            document.getElementById('equationInput').value = equation;
            evaluateEquation();
        };

        // Category icons mapping
        const categoryIcons = {
            arithmetic: '➕',
            trigonometric: '📐', 
            hyperbolic: '〰️',
            logarithmic: '📊',
            mathematical: '🧮',
            string: '📝',
            matrix: '🔢',
            array: '📊',
            date: '📅',
            time: '🕐',
            utility: '🛠️',
            comparison: '⚖️',
            conditional: '❓',
            constants: '🔢',
            aggregation: '📈',
            casting: '🔄'
        };

        // Store original function data for search
        let allFunctions = {};

        // Populate function list
        function populateFunctionList() {
            const functions = equationsParser.getSupportedFunctions();
            allFunctions = functions; // Store for search
            const functionListDiv = document.getElementById('functionList');
            
            functionListDiv.innerHTML = '';
            
            Object.entries(functions).forEach(([category, funcs]) => {
                const categoryDiv = document.createElement('div');
                categoryDiv.className = 'function-category';
                categoryDiv.setAttribute('data-category', category);
                
                const titleElement = document.createElement('h3');
                titleElement.innerHTML = `${categoryIcons[category] || '📋'} ${category.charAt(0).toUpperCase() + category.slice(1)}`;
                categoryDiv.appendChild(titleElement);
                
                const listElement = document.createElement('ul');
                funcs.forEach(func => {
                    const listItem = document.createElement('li');
                    listItem.textContent = func;
                    listItem.onclick = () => useFunctionExample(extractFunctionName(func));
                    listElement.appendChild(listItem);
                });
                
                categoryDiv.appendChild(listElement);
                functionListDiv.appendChild(categoryDiv);
            });
        }

        // Extract function name for examples (remove description)
        function extractFunctionName(funcDesc) {
            const match = funcDesc.match(/^([a-zA-Z_][a-zA-Z0-9_]*)/);
            if (match) return match[1];
            
            // Handle special operators
            if (funcDesc.includes('(addition)')) return '2 + 3';
            if (funcDesc.includes('(subtraction)')) return '5 - 2'; 
            if (funcDesc.includes('(multiplication)')) return '4 * 7';
            if (funcDesc.includes('(division)')) return '8 / 2';
            if (funcDesc.includes('(power)')) return '2 ^ 3';
            if (funcDesc.includes('ternary')) return '5 > 3 ? "yes" : "no"';
            if (funcDesc.includes('pi -')) return 'pi';
            if (funcDesc.includes('e -')) return 'e';
            
            return funcDesc.split(' ')[0]; // Fallback to first word
        }

        // Use function example
        window.useFunctionExample = function(funcName) {
            const examples = {
                // Trigonometric
                'sin': 'sin(pi/2)',
                'cos': 'cos(0)',
                'tan': 'tan(pi/4)',
                'asin': 'asin(0.5)',
                'acos': 'acos(0.5)',
                'atan': 'atan(1)',
                'atan2': 'atan2(1, 1)',
                
                // Hyperbolic
                'sinh': 'sinh(1)',
                'cosh': 'cosh(0)',
                'tanh': 'tanh(1)',
                'asinh': 'asinh(1)',
                'acosh': 'acosh(1.5)',
                'atanh': 'atanh(0.5)',
                
                // Logarithmic
                'ln': 'ln(e)',
                'log': 'log(100)',
                'log10': 'log10(100)',
                'log2': 'log2(8)',
                'exp': 'exp(1)',
                
                // Mathematical
                'abs': 'abs(-5)',
                'sqrt': 'sqrt(16)',
                'cbrt': 'cbrt(27)',
                'pow': 'pow(2, 3)',
                'hypot': 'hypot(3, 4)',
                'round': 'round(3.7)',
                'round_decimal': 'round_decimal(3.14159, 2)',
                'fmod': 'fmod(7, 3)',
                'remainder': 'remainder(7, 3)',
                
                // String functions
                'concat': 'concat("Hello", " World")',
                'length': 'length("test string")',
                'toupper': 'toupper("hello")',
                'tolower': 'tolower("WORLD")',
                'left': 'left("Hello World", 5)',
                'right': 'right("Hello World", 5)',
                'str2number': 'str2number("123.45")',
                'number': 'number("42")',
                'string': 'string(123)',
                'contains': 'contains("Hello World", "World")',
                'calculate': 'calculate("2 + 2")',
                
                // Date functions  
                'current_date': 'current_date()',
                'daysdiff': 'daysdiff("2023-12-01", "2023-12-10")',
                'hoursdiff': 'hoursdiff("2023-12-01T10:00", "2023-12-01T15:30")',
                'add_days': 'add_days("2023-12-01", 7)',
                'weekyear': 'weekyear("2023-12-01")',
                'weekday': 'weekday("2023-12-01")',
                
                // Time functions
                'current_time': 'current_time()',
                'timediff': 'timediff("10:00:00", "15:30:00")',
                
                // Matrix functions
                'ones': 'ones(2, 3)',
                'zeros': 'zeros(2, 2)',
                'eye': 'eye(3)',
                'sizeof': 'sizeof([1,2,3,4])',
                
                // Aggregation
                'min': 'min(1, 5, 2, 8)',
                'max': 'max(1, 5, 2, 8)',
                'sum': 'sum(1, 2, 3, 4)',
                'avg': 'avg(1, 2, 3, 4)',
                
                // Utility
                'mask': 'mask("000-000", 123456)',
                'regex': 'regex("Hello123", "[0-9]+")',
                'parserid': 'parserid()',
                
                // Constants already handled above in extractFunctionName
            };
            
            const example = examples[funcName] || funcName + '(1)';
            document.getElementById('equationInput').value = example;
            
            // Auto-scroll to equation input
            document.getElementById('equationInput').scrollIntoView({ behavior: 'smooth', block: 'center' });
            document.getElementById('equationInput').focus();
        };

        // Filter functions based on search
        window.filterFunctions = function() {
            const searchTerm = document.getElementById('functionSearch').value.toLowerCase();
            const categories = document.querySelectorAll('.function-category');
            
            categories.forEach(category => {
                const categoryName = category.dataset.category.toLowerCase();
                const functions = category.querySelectorAll('li');
                let hasVisibleFunctions = false;
                
                functions.forEach(func => {
                    const funcText = func.textContent.toLowerCase();
                    const isVisible = funcText.includes(searchTerm) || categoryName.includes(searchTerm);
                    func.style.display = isVisible ? 'block' : 'none';
                    if (isVisible) hasVisibleFunctions = true;
                });
                
                category.style.display = hasVisibleFunctions ? 'block' : 'none';
            });
        };

        // Run comprehensive tests
        window.runComprehensiveTests = async function() {
            const testBtn = document.getElementById('testBtn');
            const resultsDiv = document.getElementById('testResults');
            
            testBtn.disabled = true;
            testBtn.textContent = 'Running Tests...';
            resultsDiv.innerHTML = '<div class="status loading">🧪 Running comprehensive test suite...</div>';
            
            try {
                const results = await equationsParser.runComprehensiveTests();
                
                const summaryHtml = `
                    <div class="test-summary">
                        <div class="test-stat passed">${results.passed} Passed</div>
                        <div class="test-stat failed">${results.failed} Failed</div>
                    </div>
                `;
                
                const detailsHtml = results.tests.map(test => `
                    <div class="test-item ${test.passed ? 'passed' : 'failed'}">
                        <strong>${test.description}</strong><br>
                        Equation: ${test.equation}<br>
                        Expected: ${test.expected} | Actual: ${test.actual}
                        ${test.error ? `<br>Error: ${test.error}` : ''}
                    </div>
                `).join('');
                
                resultsDiv.innerHTML = `
                    <div class="test-results">
                        ${summaryHtml}
                        <div class="test-details">${detailsHtml}</div>
                    </div>
                `;
                
            } catch (error) {
                resultsDiv.innerHTML = `<div class="result error">Test execution failed: ${error.message}</div>`;
            } finally {
                testBtn.disabled = false;
                testBtn.textContent = 'Run All Tests';
            }
        };

        // Allow Enter key to evaluate equation
        document.addEventListener('DOMContentLoaded', function() {
            document.getElementById('equationInput').addEventListener('keypress', function(e) {
                if (e.key === 'Enter' && !this.disabled) {
                    evaluateEquation();
                }
            });
        });

        // Initialize everything when page loads
        initializeEquationsParser();
    </script>
</body>
</html>